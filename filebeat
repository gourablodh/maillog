filebeat.inputs:
  - type: log
    enabled: true
    paths:
      - /var/log/mail.log

    processors:
      - grok:
          match:
            message: [
              '%{TIMESTAMP_ISO8601:log.timestamp} %{HOSTNAME:log.hostname} %{DATA:log.component}\[%{NUMBER:log.pid}\]: %{GREEDYDATA:log.rest}'
            ]
          ignore_missing: true
          ignore_failure: true

      - grok:
          when:
            contains:
              log.component: "pmg-smtp-filter"
          match:
            log.rest: [
              '%{WORD:log.message_id}: accept mail to <%{DATA:log.receiver}> \(%{WORD:log.queue_id}\) \(rule: %{DATA:log.rule}\)'
            ]
          ignore_missing: true
          ignore_failure: true
 
      - grok:
          when:
            contains:
              log.component: "pmg-smtp-filter"
          match:
            log.rest: [
              '%{WORD:log.message_id}: processing time: %{NUMBER:log.proc_seconds} seconds \(%{GREEDYDATA:log.proc_breakdown}\)'
            ]
          ignore_missing: true
          ignore_failure: true

      - grok:
          when:
            contains:
              log.component: "pmg-smtp-filter"
          match:
            log.rest: [
              '%{WORD:log.message_id}: SA score=%{NUMBER:log.sa_score}/%{NUMBER:log.sa_threshold} time=%{NUMBER:log.sa_time} %{GREEDYDATA:log.sa_hits}'
            ]
          ignore_missing: true
          ignore_failure: true

      - grok:
          when:
            contains:
              log.component: "postfix"
          match:
            log.rest: [

              '%{WORD:log.queue_id}: from=<%{DATA:log.sender}>, size=%{NUMBER:log.size}, nrcpt=%{NUMBER:log.nrcpt} \(%{DATA:log.queue_status}\)',

              '%{WORD:log.queue_id}: to=<%{DATA:log.receiver}>, relay=%{DATA:log.relay}\[%{IP:log.relay_ip}\]:%{NUMBER:log.relay_port}, delay=%{NUMBER:log.delay}, delays=%{DATA:log.delays}, dsn=%{DATA:log.dsn}, status=%{WORD:log.status} \(%{GREEDYDATA:log.status_msg}\)',

              '%{WORD:log.queue_id}: removed',

              '%{WORD:log.queue_id}: message-id=<%{DATA:log.message_id}>',

              'warning: hostname %{DATA:log.warn_host} does not resolve to address %{IP:log.warn_ip}: %{GREEDYDATA:log.warn_message}',

              'Trusted TLS connection established to %{DATA:log.tls_remote_host} \[%{IP:log.tls_ip}\]:%{NUMBER:log.tls_port}: %{GREEDYDATA:log.tls_details}',

              'connect from %{DATA:log.client_host} \[%{IP:log.client_ip}\]',

              'disconnect from %{DATA:log.client_host} \[%{IP:log.client_ip}\] %{GREEDYDATA:log.disconnect_details}',

              '%{WORD:log.queue_id}: client=%{DATA:log.client_host} \[%{IP:log.client_ip}\]'
            ]
          ignore_missing: true
          ignore_failure: true

      - grok:
          when:
            contains:
              log.component: "postfix/postscreen"
          match:
            log.rest: [
              'CONNECT from \[%{IP:log.ps_client_ip}\]:%{NUMBER:log.ps_client_port} to \[%{IP:log.ps_server_ip}\]:%{NUMBER:log.ps_server_port}',
              'PASS OLD \[%{IP:log.ps_client_ip}\]:%{NUMBER:log.ps_client_port}'
            ]
          ignore_missing: true
          ignore_failure: true

      - grok:
          when:
            contains:
              log.component: "postfix/scache"
          match:
            log.rest: [

              'statistics: start interval %{GREEDYDATA:log.scache_interval}',

              'statistics: domain lookup hits=%{NUMBER:log.domain_hits} miss=%{NUMBER:log.domain_miss} success=%{NUMBER:log.domain_success}%',

              'statistics: address lookup hits=%{NUMBER:log.address_hits} miss=%{NUMBER:log.address_miss} success=%{NUMBER:log.address_success}%'
            ]
          ignore_missing: true
          ignore_failure: true

      - grok:
          when:
            contains:
              log.component: "pmgpolicy"
          match:
            log.rest: [
  
              'Received a SIG HUP',
            
              '%{GREEDYDATA:log.policy_message}'
            ]
          ignore_missing: true
          ignore_failure: true

      - rename:
          fields:
            - from: "message"
              to:   "log.original"

      - drop_fields:
          fields:
            - "log.rest"
            - "message"
